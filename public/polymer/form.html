<dom-module id="lucinda-form">
  <template>
    <form is="iron-form" id="form" on-iron-form-presubmit="presubmit" method="POST">
      <paper-input name="title" label="Title"></paper-input>
      <paper-autocomplete id="expedition" on-autocomplete-selected="selectedExpeditionValue" on-autocomplete-change="autocompleteExpedition" name="expedition" label="Expedition" remote-source="true" length="2"></paper-autocomplete>
      <paper-input name="dates" label="Dates"></paper-input>
      <paper-input name="creator" label="Creator"></paper-input>
      <paper-input name="locale" label="Where"></paper-input>
      <paper-textarea name="notes" label="Notes"></paper-textarea>
      <paper-input name="current_location" label="Current Location"></paper-input>


      <paper-button raised on-tap="submitForm">Submit</paper-button>

      <input type="hidden" name="_csrf" value="[[csrfToken]]" />
    </form>
  </template>

  <script>
    Polymer({
      is: 'lucinda-form',
      properties: {
        csrf: String,
      },
      presubmit: function() {
        var body = this.$.form.request.body;
        if (this.selectedExpedition) {
          body.selectedExpedition = this.selectedExpedition;
        }

        for (var i in body) {
          if (typeof(body[i]) === 'undefined') {
            body[i] = '';
          }
        }
      },
      submitForm: function(e) {
        this.$.form.submit();
      },
      selectedExpeditionValue: function(e, selected) {
        this.selectedExpedition = selected.value;
      },
      autocompleteExpedition: _GenerateAutocompleter('/expedition/search?q=')
    });

  function _GenerateAutocompleter(endpoint) {
    return function(e) {
      var input = e.target;
      var search = input.text;
      var url = endpoint + search;
      var req= new XMLHttpRequest();
      req.open('GET', encodeURI(url));
      req.onload = function() {
        if (req.status === 200) {
          var data = JSON.parse(req.response);
          var arr = data.map(function(obj) {
            return {text: obj.text, value: obj.id };
          });
          input.suggestions(arr);
        }
      };
      req.send();
    }
  }
  </script>
</dom-module>
